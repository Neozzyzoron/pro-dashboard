<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Widget Admin V16</title>
    <style>
        /* RESET & CORE */
        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #f7f7f5; color: #37352f; }
        
        /* MAIN LAYOUT */
        .main-container { display: flex; flex-direction: row; width: 100%; height: 100vh; overflow: hidden; }
        .panel-left { width: 50%; height: 100%; background: #fff; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; min-width: 380px; }
        .panel-right { width: 50%; height: 100%; background: #eef0f2; padding: 20px; display: flex; flex-direction: column; min-width: 320px; }
        
        .sticky-header { padding: 20px 25px; background: white; border-bottom: 1px solid #f0f0f0; flex-shrink: 0; z-index: 10; }
        .scroll-content { padding: 20px 25px 40px 25px; overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column; gap: 20px; }
        
        .preview-wrapper { flex-grow: 1; background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #ccc; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
        .preview-toolbar { padding: 8px; background: #dfe1e6; border-bottom: 1px solid #ccc; display: flex; justify-content: center; align-items: center; height: 30px; flex-shrink: 0; }
        .preview-label { font-size: 0.75rem; font-weight: bold; color: #555; text-transform: uppercase; letter-spacing: 1px;}
        iframe { flex-grow: 1; width: 100%; border: none; background: white; display: block; }

        /* TYPOGRAPHY & UI */
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: -0.5px; }
        h2 { font-size: 0.85rem; color: #999; text-transform: uppercase; margin: 0 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 5px; letter-spacing: 0.5px; font-weight: 600;}
        .dark-section { background: #34495e; padding: 15px; border-radius: 8px; color: white; flex-shrink: 0; }
        .dark-section h2 { color: rgba(255,255,255,0.7); border-bottom-color: rgba(255,255,255,0.2); }
        .dark-section label { color: rgba(255,255,255,0.9); }
        
        .action-area { padding: 15px; background: #2c3e50; border-radius: 8px; color: white; }
        .link-box { background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; font-family: monospace; font-size: 0.75rem; word-break: break-all; margin-bottom: 10px; max-height: 45px; overflow-y: auto; color: #aeb6bf; }
        .action-btns { display: flex; gap: 8px; }
        .btn-action { padding: 10px; font-size: 0.8rem; color: white; border-radius: 4px; border:none; cursor: pointer; font-weight: 600; transition: background 0.2s; }
        .btn-refresh { background: #3498db; flex: 2; } .btn-refresh:hover { background: #2980b9; }
        .btn-copy { background: #27ae60; flex: 2; border: 1px solid #2ecc71; } .btn-copy:hover { background: #219150; }
        .btn-open { background: #7f8c8d; flex: 0; min-width: 40px; font-size: 1.2rem; padding: 0; display:flex; align-items:center; justify-content:center;} .btn-open:hover { background: #95a5a6; }

        /* BLOCKS */
        .block-card { background: white; border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #999; transition: all 0.2s; }
        .block-header { padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; background: #fbfbfa; user-select: none; }
        .block-header:hover { background: #f2f2f2; }
        .block-title { font-weight: 600; font-size: 0.85rem; flex-grow: 1; text-transform: uppercase; color: #555; }
        .toggle-icon { font-size: 0.7rem; color: #bbb; transition: transform 0.2s; }
        .block-card.open .toggle-icon { transform: rotate(180deg); }
        .block-content { padding: 15px; border-top: 1px solid #f0f0f0; display: none; }
        .block-card.open .block-content { display: block; }
        
        /* SUB LIST ITEMS */
        .sub-list { margin-bottom: 10px; border: 1px solid #eee; padding: 10px; border-radius: 4px; background: #fafafa; }
        .sub-item { display: flex; gap: 5px; margin-bottom: 8px; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .sub-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        
        /* Common Inputs */
        .sub-item select, .sub-item input { flex-grow: 1; width: auto; min-width: 0; } 
        
        /* Buttons */
        .sub-btn-add { background: #e0e0e0; border: none; font-size: 0.7rem; padding: 4px 8px; cursor: pointer; border-radius: 3px; }
        .sub-btn-rem { background: #ffdede; color: red; border: none; cursor: pointer; width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        .sub-btn-mov { background: #f0f0f0; border: 1px solid #ddd; cursor: pointer; width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; color: #666; flex-shrink: 0; }

        .type-header { border-left-color: #bdc3c7; } .type-world_clock { border-left-color: #1abc9c; }
        .type-date_display { border-left-color: #2ecc71; } .type-progress_group { border-left-color: #e67e22; }
        .type-progress_custom { border-left-color: #f1c40f; } .type-progress_cycle { border-left-color: #9b59b6; }
        .type-countdown { border-left-color: #3498db; } .type-timer { border-left-color: #e74c3c; }

        .settings-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        label { display: block; margin-bottom: 4px; font-weight: 500; font-size: 0.75rem; color: #666;}
        input, select, textarea { width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; box-sizing: border-box; background: #fff; }
        input:focus, select:focus, textarea:focus { border-color: #2ecc71; outline: none; }
        .row { display: flex; gap: 10px; margin-top: 10px; } .col { flex: 1; }
        .viz-controls { background: #f9f9f9; padding: 10px; border-radius: 4px; margin-top: 10px; border: 1px solid #eee; }

        .btn-row { display: flex; gap: 8px; flex-wrap: wrap; }
        button { padding: 8px 12px; border: none; border-radius: 4px; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: transform 0.1s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-header { background: #ecf0f1; color: #7f8c8d; } .btn-time { background: #d1f2eb; color: #0e6251; }
        .btn-date { background: #d5f5e3; color: #196f3d; } .btn-auto { background: #fdebd0; color: #935116; }
        .btn-custom { background: #fcf3cf; color: #7d6608; } .btn-cycle { background: #ebdef0; color: #5b2c6f; }
        .btn-count { background: #d6eaf8; color: #154360; } .btn-timer { background: #fadbd8; color: #78281f; }
        .btn-del { background: transparent; color: #c0392b; border: 1px solid #e74c3c; padding: 3px 6px; font-size: 0.65rem; }
        
        .city-search-wrapper { position: relative; flex: 1; }
        .city-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 0 0 4px 4px; max-height: 150px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; }
        .city-result-item { padding: 8px; cursor: pointer; font-size: 0.85rem; border-bottom: 1px solid #f0f0f0; }
        .city-result-item:hover { background: #f0f0f0; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="panel-left">
        <div class="sticky-header">
            <h1>Widget Builder</h1>
            <div class="action-area">
                <label style="color:#aaa; font-size:0.7rem;">WIDGET LINK</label>
                <div class="link-box" id="result-url">Generate...</div>
                <div class="action-btns">
                    <button class="btn-action btn-refresh" onclick="refreshPreview()">â†» REFRESH PREVIEW</button>
                    <button class="btn-action btn-copy" id="btn-copy" onclick="copyLink()">COPY LINK</button>
                    <button class="btn-action btn-open" onclick="window.open(generateLink(), '_blank')" title="Open in New Tab">â¬ˆ</button>
                </div>
            </div>
        </div>

        <div class="scroll-content">
            <div class="dark-section">
                <h2>Global Settings</h2>
                <div class="settings-grid">
                    <div><label>Time</label><select id="set-time" onchange="updateState()"><option value="12">12 Hour</option><option value="24">24 Hour</option></select></div>
                    <div><label>Theme</label><select id="set-theme" onchange="updateState()"><option value="standard">Standard</option><option value="minimal">Minimal</option><option value="card">Cards</option></select></div>
                    <div><label>Font Size</label><select id="set-font" onchange="updateState()"><option value="standard">Standard</option><option value="small">Small</option><option value="large">Large</option></select></div>
                </div>
            </div>

            <div class="section">
                <h2>Blocks</h2>
                <div id="blocks-area"></div>
                <div class="btn-row" style="margin-top:15px;">
                    <button class="btn-header" onclick="addBlock('header')">+ Text</button>
                    <button class="btn-time" onclick="addBlock('world_clock')">+ Time</button>
                    <button class="btn-date" onclick="addBlock('date_display')">+ Date</button>
                    <button class="btn-auto" onclick="addBlock('progress_group')">+ Auto Progress</button>
                    <button class="btn-custom" onclick="addBlock('progress_custom')">+ Custom Progress</button>
                    <button class="btn-cycle" onclick="addBlock('progress_cycle')">+ Cycle Progress</button>
                    <button class="btn-count" onclick="addBlock('countdown')">+ Countdown</button>
                    <button class="btn-timer" onclick="addBlock('timer')">+ Timer</button>
                </div>
            </div>
        </div>
    </div>

    <div class="panel-right">
        <div class="preview-wrapper">
            <div class="preview-toolbar"><span class="preview-label">Live Preview</span></div>
            <iframe id="preview-frame" src=""></iframe>
        </div>
    </div>
</div>

<script>
    let settings = { use24h: false, theme: 'standard', fontSize: 'standard' };
    let blocks = [];
    let dragSrc = null;
    
    // FULL CITY DATABASE
    const cityDB = [
        {name: "Abidjan, Ivory Coast", tz: "Africa/Abidjan"}, {name: "Abu Dhabi, UAE", tz: "Asia/Dubai"},
        {name: "Accra, Ghana", tz: "Africa/Accra"}, {name: "Addis Ababa, Ethiopia", tz: "Africa/Addis_Ababa"},
        {name: "Adelaide, Australia", tz: "Australia/Adelaide"}, {name: "Algiers, Algeria", tz: "Africa/Algiers"},
        {name: "Almaty, Kazakhstan", tz: "Asia/Almaty"}, {name: "Amman, Jordan", tz: "Asia/Amman"},
        {name: "Amsterdam, Netherlands", tz: "Europe/Amsterdam"}, {name: "Anchorage, USA", tz: "America/Anchorage"},
        {name: "Ankara, Turkey", tz: "Europe/Istanbul"}, {name: "Antananarivo, Madagascar", tz: "Indian/Antananarivo"},
        {name: "Athens, Greece", tz: "Europe/Athens"}, {name: "Atlanta, USA", tz: "America/New_York"},
        {name: "Auckland, New Zealand", tz: "Pacific/Auckland"}, {name: "Austin, USA", tz: "America/Chicago"},
        {name: "Baghdad, Iraq", tz: "Asia/Baghdad"}, {name: "Baku, Azerbaijan", tz: "Asia/Baku"},
        {name: "Bangkok, Thailand", tz: "Asia/Bangkok"}, {name: "Barcelona, Spain", tz: "Europe/Madrid"},
        {name: "Beijing, China", tz: "Asia/Shanghai"}, {name: "Beirut, Lebanon", tz: "Asia/Beirut"},
        {name: "Belgrade, Serbia", tz: "Europe/Belgrade"}, {name: "Bengaluru, India", tz: "Asia/Kolkata"},
        {name: "Berlin, Germany", tz: "Europe/Berlin"}, {name: "Bogota, Colombia", tz: "America/Bogota"},
        {name: "Boston, USA", tz: "America/New_York"}, {name: "Brasilia, Brazil", tz: "America/Sao_Paulo"},
        {name: "Brisbane, Australia", tz: "Australia/Brisbane"}, {name: "Brussels, Belgium", tz: "Europe/Brussels"},
        {name: "Bucharest, Romania", tz: "Europe/Bucharest"}, {name: "Budapest, Hungary", tz: "Europe/Budapest"},
        {name: "Buenos Aires, Argentina", tz: "America/Argentina/Buenos_Aires"}, {name: "Cairo, Egypt", tz: "Africa/Cairo"},
        {name: "Calgary, Canada", tz: "America/Edmonton"}, {name: "Canberra, Australia", tz: "Australia/Sydney"},
        {name: "Cape Town, South Africa", tz: "Africa/Johannesburg"}, {name: "Caracas, Venezuela", tz: "America/Caracas"},
        {name: "Casablanca, Morocco", tz: "Africa/Casablanca"}, {name: "Chennai, India", tz: "Asia/Kolkata"},
        {name: "Chicago, USA", tz: "America/Chicago"}, {name: "Copenhagen, Denmark", tz: "Europe/Copenhagen"},
        {name: "Dakar, Senegal", tz: "Africa/Dakar"}, {name: "Dallas, USA", tz: "America/Chicago"},
        {name: "Dar es Salaam, Tanzania", tz: "Africa/Dar_es_Salaam"}, {name: "Darwin, Australia", tz: "Australia/Darwin"},
        {name: "Delhi (New Delhi), India", tz: "Asia/Kolkata"}, {name: "Denpasar, Indonesia", tz: "Asia/Makassar"},
        {name: "Denver, USA", tz: "America/Denver"}, {name: "Detroit, USA", tz: "America/Detroit"},
        {name: "Dhaka, Bangladesh", tz: "Asia/Dhaka"}, {name: "Doha, Qatar", tz: "Asia/Qatar"},
        {name: "Dubai, UAE", tz: "Asia/Dubai"}, {name: "Dublin, Ireland", tz: "Europe/Dublin"},
        {name: "Edmonton, Canada", tz: "America/Edmonton"}, {name: "Frankfurt, Germany", tz: "Europe/Berlin"},
        {name: "Geneva, Switzerland", tz: "Europe/Zurich"}, {name: "Guatemala City, Guatemala", tz: "America/Guatemala"},
        {name: "Halifax, Canada", tz: "America/Halifax"}, {name: "Hanoi, Vietnam", tz: "Asia/Ho_Chi_Minh"},
        {name: "Harare, Zimbabwe", tz: "Africa/Harare"}, {name: "Havana, Cuba", tz: "America/Havana"},
        {name: "Helsinki, Finland", tz: "Europe/Helsinki"}, {name: "Hong Kong", tz: "Asia/Hong_Kong"},
        {name: "Honolulu, USA", tz: "Pacific/Honolulu"}, {name: "Houston, USA", tz: "America/Chicago"},
        {name: "Indianapolis, USA", tz: "America/Indiana/Indianapolis"}, {name: "Islamabad, Pakistan", tz: "Asia/Karachi"},
        {name: "Istanbul, Turkey", tz: "Europe/Istanbul"}, {name: "Jakarta, Indonesia", tz: "Asia/Jakarta"},
        {name: "Jerusalem, Israel", tz: "Asia/Jerusalem"}, {name: "Johannesburg, South Africa", tz: "Africa/Johannesburg"},
        {name: "Kabul, Afghanistan", tz: "Asia/Kabul"}, {name: "Kampala, Uganda", tz: "Africa/Kampala"},
        {name: "Karachi, Pakistan", tz: "Asia/Karachi"}, {name: "Kathmandu, Nepal", tz: "Asia/Kathmandu"},
        {name: "Khartoum, Sudan", tz: "Africa/Khartoum"}, {name: "Kingston, Jamaica", tz: "America/Jamaica"},
        {name: "Kinshasa, DRC", tz: "Africa/Kinshasa"}, {name: "Kolkata, India", tz: "Asia/Kolkata"},
        {name: "Kuala Lumpur, Malaysia", tz: "Asia/Kuala_Lumpur"}, {name: "Kuwait City, Kuwait", tz: "Asia/Kuwait"},
        {name: "Kyiv, Ukraine", tz: "Europe/Kyiv"}, {name: "Lagos, Nigeria", tz: "Africa/Lagos"},
        {name: "Lahore, Pakistan", tz: "Asia/Karachi"}, {name: "Las Vegas, USA", tz: "America/Los_Angeles"},
        {name: "Lima, Peru", tz: "America/Lima"}, {name: "Lisbon, Portugal", tz: "Europe/Lisbon"},
        {name: "London, UK", tz: "Europe/London"}, {name: "Los Angeles, USA", tz: "America/Los_Angeles"},
        {name: "Luanda, Angola", tz: "Africa/Luanda"}, {name: "Madrid, Spain", tz: "Europe/Madrid"},
        {name: "Manila, Philippines", tz: "Asia/Manila"}, {name: "Melbourne, Australia", tz: "Australia/Melbourne"},
        {name: "Mexico City, Mexico", tz: "America/Mexico_City"}, {name: "Miami, USA", tz: "America/New_York"},
        {name: "Minneapolis, USA", tz: "America/Chicago"}, {name: "Minsk, Belarus", tz: "Europe/Minsk"},
        {name: "Montevideo, Uruguay", tz: "America/Montevideo"}, {name: "Montreal, Canada", tz: "America/Toronto"},
        {name: "Moscow, Russia", tz: "Europe/Moscow"}, {name: "Mumbai, India", tz: "Asia/Kolkata"},
        {name: "Munich, Germany", tz: "Europe/Berlin"}, {name: "Muscat, Oman", tz: "Asia/Muscat"},
        {name: "Nairobi, Kenya", tz: "Africa/Nairobi"}, {name: "New Delhi, India", tz: "Asia/Kolkata"},
        {name: "New Orleans, USA", tz: "America/Chicago"}, {name: "New York, USA", tz: "America/New_York"},
        {name: "Oslo, Norway", tz: "Europe/Oslo"}, {name: "Ottawa, Canada", tz: "America/Toronto"},
        {name: "Panama, Panama", tz: "America/Panama"}, {name: "Paris, France", tz: "Europe/Paris"},
        {name: "Perth, Australia", tz: "Australia/Perth"}, {name: "Philadelphia, USA", tz: "America/New_York"},
        {name: "Phoenix, USA", tz: "America/Phoenix"}, {name: "Prague, Czechia", tz: "Europe/Prague"},
        {name: "Pune, India", tz: "Asia/Kolkata"}, {name: "Pyongyang, North Korea", tz: "Asia/Pyongyang"},
        {name: "Quito, Ecuador", tz: "America/Guayaquil"}, {name: "Reykjavik, Iceland", tz: "Atlantic/Reykjavik"},
        {name: "Rio de Janeiro, Brazil", tz: "America/Sao_Paulo"}, {name: "Riyadh, Saudi Arabia", tz: "Asia/Riyadh"},
        {name: "Rome, Italy", tz: "Europe/Rome"}, {name: "Salt Lake City, USA", tz: "America/Denver"},
        {name: "San Francisco, USA", tz: "America/Los_Angeles"}, {name: "San Jose, USA", tz: "America/Los_Angeles"},
        {name: "San Juan, Puerto Rico", tz: "America/Puerto_Rico"}, {name: "San Salvador, El Salvador", tz: "America/El_Salvador"},
        {name: "Santiago, Chile", tz: "America/Santiago"}, {name: "Santo Domingo, Dominican Republic", tz: "America/Santo_Domingo"},
        {name: "Sao Paulo, Brazil", tz: "America/Sao_Paulo"}, {name: "Seattle, USA", tz: "America/Los_Angeles"},
        {name: "Seoul, South Korea", tz: "Asia/Seoul"}, {name: "Shanghai, China", tz: "Asia/Shanghai"},
        {name: "Singapore, Singapore", tz: "Asia/Singapore"}, {name: "Sofia, Bulgaria", tz: "Europe/Sofia"},
        {name: "Stockholm, Sweden", tz: "Europe/Stockholm"}, {name: "Sydney, Australia", tz: "Australia/Sydney"},
        {name: "Taipei, Taiwan", tz: "Asia/Taipei"}, {name: "Tallinn, Estonia", tz: "Europe/Tallinn"},
        {name: "Tashkent, Uzbekistan", tz: "Asia/Tashkent"}, {name: "Tehran, Iran", tz: "Asia/Tehran"},
        {name: "Tel Aviv, Israel", tz: "Asia/Jerusalem"}, {name: "Tokyo, Japan", tz: "Asia/Tokyo"},
        {name: "Toronto, Canada", tz: "America/Toronto"}, {name: "Tunis, Tunisia", tz: "Africa/Tunis"},
        {name: "Vancouver, Canada", tz: "America/Vancouver"}, {name: "Vienna, Austria", tz: "Europe/Vienna"},
        {name: "Vladivostok, Russia", tz: "Asia/Vladivostok"}, {name: "Warsaw, Poland", tz: "Europe/Warsaw"},
        {name: "Washington DC, USA", tz: "America/New_York"}, {name: "Wellington, New Zealand", tz: "Pacific/Auckland"},
        {name: "Winnipeg, Canada", tz: "America/Winnipeg"}, {name: "Yangon, Myanmar", tz: "Asia/Yangon"},
        {name: "Yerevan, Armenia", tz: "Asia/Yerevan"}, {name: "Zagreb, Croatia", tz: "Europe/Zagreb"},
        {name: "Zurich, Switzerland", tz: "Europe/Zurich"}
    ];

    // DATE TOKENS
    const dateTokens = [
        {val: 'day_name_full', txt: 'Day Name (Monday)'}, {val: 'day_name_short', txt: 'Day Name (Mon)'},
        {val: 'date_num', txt: 'Date (28)'}, {val: 'month_full', txt: 'Month (January)'},
        {val: 'month_short', txt: 'Month (Jan)'}, {val: 'month_num', txt: 'Month Number (01)'},
        {val: 'year', txt: 'Year (2026)'}, {val: 'week_num', txt: 'Week Number'},
        {val: 'day_year', txt: 'Day of Year'}, {val: 'quarter', txt: 'Quarter (Q1)'},
        {val: 'separator', txt: 'Separator (|)'}
    ];

    function init() {
        try {
            const hash = window.location.hash.substring(1);
            if(hash) {
                const data = JSON.parse(atob(hash));
                settings = data.settings || settings;
                blocks = data.blocks || blocks;
                document.getElementById('set-time').value = settings.use24h ? '24' : '12';
                document.getElementById('set-theme').value = settings.theme;
                document.getElementById('set-font').value = settings.fontSize;
            } else { blocks = [{ type: 'header', text: 'Welcome' }]; }
        } catch(e) { console.error(e); }
        renderBlocks();
        setTimeout(refreshPreview, 1000);
    }

    // --- PREVIEW LOGIC ---
    window.refreshPreview = () => {
        const json = JSON.stringify({ settings, blocks });
        const encoded = btoa(json);
        const parts = window.location.href.split('#');
        let baseUrl = parts[0];
        if(baseUrl.includes('admin.html')) baseUrl = baseUrl.replace('admin.html', 'index.html');
        else if(baseUrl.endsWith('/')) baseUrl += 'index.html';
        else baseUrl += '/index.html';
        
        // V6 Timestamp Method
        const url = `${baseUrl}?t=${Date.now()}#${encoded}`;
        
        const frame = document.getElementById('preview-frame');
        if(frame) frame.src = url;
        
        generateLink();
    };

    window.updateBlockAndRender = (idx, key, val) => {
        blocks[idx][key] = val;
        updateState();
        renderBlocks();
    };

    function renderBlocks() {
        const openIndices = [];
        document.querySelectorAll('.block-card').forEach(el => {
            if(el.classList.contains('open')) openIndices.push(parseInt(el.dataset.index));
        });

        const area = document.getElementById('blocks-area');
        if(!area) return;
        area.innerHTML = '';

        blocks.forEach((block, index) => {
            const div = document.createElement('div');
            div.className = `block-card type-${block.type}`;
            div.draggable = true;
            div.dataset.index = index;
            if(openIndices.includes(index)) div.classList.add('open');

            div.addEventListener('dragstart', function(e) { dragSrc = this; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', this.innerHTML); this.classList.add('dragging'); });
            div.addEventListener('dragover', function(e) { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; });
            div.addEventListener('drop', handleDrop);
            div.addEventListener('dragend', function() { this.classList.remove('dragging'); });

            let title = block.type.toUpperCase().replace('_',' ');
            if(block.type === 'world_clock') title = "TIME";
            if(block.type === 'progress_group') title = "PROGRESS (AUTO)";
            if(block.type === 'progress_custom') title = "PROGRESS (CUSTOM)";
            if(block.type === 'progress_cycle') title = "PROGRESS (CYCLE)";
            let label = block.label || block.text || title;

            let html = `
                <div class="block-header" onclick="this.parentElement.classList.toggle('open')">
                    <span style="color:#ccc;">â˜°</span>
                    <span class="block-title">${title} <span style="opacity:0.5; text-transform:none; margin-left:8px;">${label.substring(0,20)}</span></span>
                    <button class="btn-del" onclick="event.stopPropagation(); removeBlock(${index})">DEL</button>
                    <span class="toggle-icon">â–¼</span>
                </div>
                <div class="block-content">
            `;

            if (block.type === 'header') html += `<label>Text</label><input type="text" value="${block.text}" oninput="updateBlock(${index}, 'text', this.value)">`;
            
            else if (block.type === 'world_clock') {
                html += `<label>Locations</label><div class="sub-list" id="sub-list-${index}"></div>`;
                html += `<button class="sub-btn-add" onclick="addSubItem(${index}, 'locations')">+ Add City</button>`;
            }
            
            else if (block.type === 'date_display') {
                 html += `<label>Line 1 (Bold)</label><div class="sub-list" id="sub-list-l1-${index}"></div>`;
                 html += `<button class="sub-btn-add" onclick="addDateItem(${index}, 'line1')">+ Add Element</button>`;
                 html += `<div style="margin-top:10px;"><label>Line 2 (Light)</label><div class="sub-list" id="sub-list-l2-${index}"></div>`;
                 html += `<button class="sub-btn-add" onclick="addDateItem(${index}, 'line2')">+ Add Element</button></div>`;
            }

            else if (block.type === 'progress_group') {
                html += `<label>Enabled Bars</label><div class="sub-list" id="sub-list-${index}"></div>`;
            }

            else if (block.type === 'progress_custom') html += `<label>Label</label><input type="text" value="${block.label}" oninput="updateBlock(${index}, 'label', this.value)"><div class="row"><div class="col"><label>Start</label><input type="date" value="${block.start}" oninput="updateBlock(${index}, 'start', this.value)"></div><div class="col"><label>End</label><input type="date" value="${block.end}" oninput="updateBlock(${index}, 'end', this.value)"></div></div>`;
            
            else if (block.type === 'progress_cycle') {
                html += `<label>Label</label><input type="text" value="${block.label}" oninput="updateBlock(${index}, 'label', this.value)"><div class="row"><div class="col"><label>Anchor</label><input type="date" value="${block.anchor}" oninput="updateBlock(${index}, 'anchor', this.value)"></div><div class="col"><label>Days</label><input type="number" value="${block.days}" oninput="updateBlock(${index}, 'days', this.value)"></div></div>`;
                html += `<div style="margin-top:8px;"><label>Reset Logic</label><select onchange="updateBlock(${index}, 'resetMode', this.value)"><option value="auto" ${block.resetMode!='manual'?'selected':''}>Automatic Loop</option><option value="manual" ${block.resetMode=='manual'?'selected':''}>Manual (Freeze & Reset)</option></select></div>`;
            }
            
            else if (block.type === 'countdown') {
                html += `<label>Label</label><input type="text" value="${block.label}" oninput="updateBlock(${index}, 'label', this.value)"><div class="row"><div class="col"><label>Target Date</label><input type="date" value="${block.date}" oninput="updateBlock(${index}, 'date', this.value)"></div><div class="col"><label>Format</label><select onchange="updateBlock(${index}, 'style', this.value)"><option value="standard" ${block.style=='standard'?'selected':''}>Standard (5 Days)</option><option value="precise" ${block.style=='precise'?'selected':''}>Precise (5d 4h)</option><option value="full" ${block.style=='full'?'selected':''}>Full (5d 4h 30m)</option></select></div></div>`;
                const hasTime = block.includeTime === true;
                html += `<div style="margin-top:8px; display:flex; align-items:center; gap:8px;"><input type="checkbox" style="width:auto;" onchange="updateBlockAndRender(${index}, 'includeTime', this.checked)" ${hasTime?'checked':''}> <label style="margin:0; font-weight:400;">Include specific time?</label></div>`;
                if(hasTime) {
                    html += `<div style="margin-top:5px;"><label>Target Time</label><input type="time" value="${block.time || '00:00'}" oninput="updateBlock(${index}, 'time', this.value)"></div>`;
                }
            }
            
            else if (block.type === 'timer') html += `<label>Label</label><input type="text" value="${block.label}" oninput="updateBlock(${index}, 'label', this.value)"><div class="row"><div class="col"><label>Hours</label><input type="number" value="${block.hours}" oninput="updateBlock(${index}, 'hours', this.value)"></div><div class="col"><label>Minutes</label><input type="number" value="${block.minutes}" oninput="updateBlock(${index}, 'minutes', this.value)"></div></div>`;

            html += `
                <div class="viz-controls">
                    <div class="row" style="margin-top:0;">
                        <div class="col"><label>Color</label>
                        <div style="display:flex; gap:5px;">
                            <select onchange="updateBlock(${index}, 'color', this.value)" style="flex:1;">
                                <option value="default">Default</option>
                                <option value="gray" ${block.color=='gray'?'selected':''}>Gray</option>
                                <option value="slate" ${block.color=='slate'?'selected':''}>Slate</option>
                                <option value="brown" ${block.color=='brown'?'selected':''}>Brown</option>
                                <option value="orange" ${block.color=='orange'?'selected':''}>Orange</option>
                                <option value="amber" ${block.color=='amber'?'selected':''}>Amber</option>
                                <option value="yellow" ${block.color=='yellow'?'selected':''}>Yellow</option>
                                <option value="lime" ${block.color=='lime'?'selected':''}>Lime</option>
                                <option value="green" ${block.color=='green'?'selected':''}>Green</option>
                                <option value="teal" ${block.color=='teal'?'selected':''}>Teal</option>
                                <option value="cyan" ${block.color=='cyan'?'selected':''}>Cyan</option>
                                <option value="blue" ${block.color=='blue'?'selected':''}>Blue</option>
                                <option value="indigo" ${block.color=='indigo'?'selected':''}>Indigo</option>
                                <option value="purple" ${block.color=='purple'?'selected':''}>Purple</option>
                                <option value="pink" ${block.color=='pink'?'selected':''}>Pink</option>
                                <option value="rose" ${block.color=='rose'?'selected':''}>Rose</option>
                                <option value="red" ${block.color=='red'?'selected':''}>Red</option>
                            </select>
                            <input type="color" value="${block.color && block.color.startsWith('#')?block.color:'#000000'}" onchange="updateBlock(${index}, 'color', this.value)" style="width:30px;height:32px;cursor:pointer;">
                        </div>
                        </div>
                        <div class="col"><label>Width</label><select onchange="updateBlock(${index}, 'width', this.value)"><option value="100">Full</option><option value="50" ${block.width=='50'?'selected':''}>Half</option></select></div>
                    </div>
                </div></div>`;
            div.innerHTML = html;
            area.appendChild(div);

            if(block.type === 'world_clock') renderCityList(index, block.locations);
            if(block.type === 'progress_group') renderAutoProgressList(index, block.items);
            if(block.type === 'date_display') {
                if(!block.line1) block.line1 = ['day_name_full', 'month_full', 'date_num'];
                if(!block.line2) block.line2 = ['week_num', 'separator', 'quarter'];
                renderDateList(index, 'line1', block.line1);
                renderDateList(index, 'line2', block.line2);
            }
        });
    }

    function renderCityList(bIdx, array) {
        const container = document.getElementById(`sub-list-${bIdx}`);
        if(!container) return;
        container.innerHTML = '';
        array.forEach((item, iIdx) => {
            const row = document.createElement('div');
            row.className = 'sub-item';
            
            // --- TIME WIDGET FIX: Side-by-Side 50/50 ---
            const wrapper = document.createElement('div');
            wrapper.style.display = 'flex'; 
            wrapper.style.width = '100%'; 
            wrapper.style.gap = '8px'; 
            wrapper.style.alignItems = 'flex-start';
            
            // 1. Search Box
            const searchWrap = document.createElement('div');
            searchWrap.className = 'city-search-wrapper';
            searchWrap.style.flex = '1';
            
            const input = document.createElement('input');
            input.placeholder = "ðŸ” Search City...";
            
            // UX FIX: Persist text so user knows what's selected
            input.value = item._searchVal || ''; 
            
            input.oninput = (e) => showCitySuggestions(e.target, bIdx, iIdx);
            
            const results = document.createElement('div');
            results.className = 'city-results';
            
            searchWrap.appendChild(input); 
            searchWrap.appendChild(results);
            
            // 2. Label Box
            const lblInput = document.createElement('input');
            lblInput.placeholder = "Label";
            lblInput.style.flex = '1'; 
            lblInput.value = item.label || '';
            lblInput.oninput = (e) => { blocks[bIdx].locations[iIdx].label = e.target.value; updateState(); };
            
            // 3. Delete
            const del = document.createElement('button'); del.className = 'sub-btn-rem'; del.innerText = 'Ã—';
            del.onclick = () => removeSubItem(bIdx, 'locations', iIdx);
            
            wrapper.appendChild(searchWrap);
            wrapper.appendChild(lblInput);
            wrapper.appendChild(del);
            
            row.appendChild(wrapper);
            container.appendChild(row);
        });
    }

    function showCitySuggestions(input, bIdx, iIdx) {
        const val = input.value.toLowerCase();
        const results = input.nextElementSibling;
        results.innerHTML = '';
        if(val.length < 2) { results.style.display = 'none'; return; }
        const matches = cityDB.filter(c => c.name.toLowerCase().includes(val)).slice(0, 5);
        if(matches.length === 0) { results.style.display = 'none'; return; }
        matches.forEach(city => {
            const div = document.createElement('div');
            div.className = 'city-result-item';
            div.innerText = city.name;
            div.onclick = () => {
                // UX FIX: Update search box to show selection
                blocks[bIdx].locations[iIdx]._searchVal = city.name;
                
                // UX FIX: Always overwrite label with City Name
                blocks[bIdx].locations[iIdx].label = city.name.split(',')[0];
                
                blocks[bIdx].locations[iIdx].timezone = city.tz;
                updateState(); 
                renderBlocks(); 
            };
            results.appendChild(div);
        });
        results.style.display = 'block';
        document.addEventListener('click', function close(e) {
            if(!input.contains(e.target) && !results.contains(e.target)) {
                results.style.display = 'none';
                document.removeEventListener('click', close);
            }
        });
    }

    function renderAutoProgressList(bIdx, array) {
        const container = document.getElementById(`sub-list-${bIdx}`);
        if(!container) return;
        container.innerHTML = '';
        array.forEach((item, iIdx) => {
            const row = document.createElement('div');
            row.className = 'sub-item';
            row.style.flexWrap = 'wrap'; /* Allow wrapping for Life row */
            
            // --- AUTO PROGRESS LAYOUT FIX ---
            // Main Row: [Check] [Label] [Life Inputs if needed] [Arrows]
            
            const check = document.createElement('input'); 
            check.type = 'checkbox'; 
            check.style.width = 'auto'; check.style.margin = '0 8px 0 0';
            check.checked = item.visible !== false;
            check.onchange = (e) => { blocks[bIdx].items[iIdx].visible = e.target.checked; updateState(); };
            
            const lbl = document.createElement('input'); 
            lbl.style.flex = '1'; 
            lbl.style.minWidth = '80px';
            lbl.value = item.label;
            lbl.oninput = (e) => { blocks[bIdx].items[iIdx].label = e.target.value; updateState(); };
            
            row.appendChild(check);
            row.appendChild(lbl);

            // LIFE INPUTS (Inline if possible, otherwise wrap)
            if(item.type === 'life') {
                const lifeGroup = document.createElement('div');
                lifeGroup.style.display = 'flex'; 
                lifeGroup.style.gap = '5px';
                lifeGroup.style.flex = '2'; /* Take more space */
                lifeGroup.style.minWidth = '200px'; 
                
                lifeGroup.innerHTML = `
                    <input type="date" title="Birth Date" value="${item.dob || '1990-01-01'}" oninput="updateSubItem(${bIdx}, 'items', ${iIdx}, 'dob', this.value)" style="flex:2">
                    <input type="number" title="Exp Age" value="${item.expectancy || 80}" oninput="updateSubItem(${bIdx}, 'items', ${iIdx}, 'expectancy', this.value)" style="flex:1; min-width:50px;">
                `;
                row.appendChild(lifeGroup);
            }

            // ARROWS
            const up = document.createElement('button'); up.className = 'sub-btn-mov'; up.innerText = 'â†‘';
            up.onclick = () => moveItem(bIdx, 'items', iIdx, -1);
            const down = document.createElement('button'); down.className = 'sub-btn-mov'; down.innerText = 'â†“';
            down.onclick = () => moveItem(bIdx, 'items', iIdx, 1);
            
            row.appendChild(up);
            row.appendChild(down);
            
            container.appendChild(row);
        });
    }

    function renderDateList(bIdx, key, array) {
        const container = document.getElementById(`sub-list-${key==='line1'?'l1':'l2'}-${bIdx}`);
        if(!container) return;
        container.innerHTML = '';
        array.forEach((item, iIdx) => {
            const row = document.createElement('div'); row.className = 'sub-item';
            const sel = document.createElement('select');
            const currVal = (typeof item === 'string') ? item : item.type;
            dateTokens.forEach(t => { sel.innerHTML += `<option value="${t.val}" ${currVal==t.val?'selected':''}>${t.txt}</option>`; });
            sel.onchange = (e) => { blocks[bIdx][key][iIdx] = e.target.value; updateState(); };
            const del = document.createElement('button'); del.className = 'sub-btn-rem'; del.innerText = 'Ã—';
            del.onclick = () => { blocks[bIdx][key].splice(iIdx, 1); renderBlocks(); updateState(); };
            row.appendChild(sel); row.appendChild(del); container.appendChild(row);
        });
    }

    window.updateState = () => {
        settings.use24h = document.getElementById('set-time').value === '24';
        settings.theme = document.getElementById('set-theme').value;
        settings.fontSize = document.getElementById('set-font').value;
        refreshPreview();
    };

    window.updateBlock = (i, k, v) => { blocks[i][k] = v; updateState(); };
    window.updateSubItem = (bI, k, iI, f, v) => { blocks[bI][k][iI][f] = v; updateState(); };
    window.addSubItem = (bI, k) => { 
        if(k==='locations') blocks[bI][k].push({label:'', timezone:''}); // UX: Empty label/tz
        if(k==='items') blocks[bI][k].push({label:'New Bar', type:'month'});
        renderBlocks(); updateState();
    };
    window.addDateItem = (bI, key) => { if(!blocks[bI][key]) blocks[bI][key] = []; blocks[bI][key].push('separator'); renderBlocks(); updateState(); };
    window.removeSubItem = (bI, k, iI) => { blocks[bI][k].splice(iI, 1); renderBlocks(); updateState(); };
    
    window.moveItem = (bI, k, iI, dir) => {
        const arr = blocks[bI][k];
        if (iI + dir >= 0 && iI + dir < arr.length) {
            [arr[iI], arr[iI + dir]] = [arr[iI + dir], arr[iI]];
            renderBlocks(); updateState();
        }
    };

    window.addBlock = (t) => {
        let b = { type: t };
        if(t=='header') b.text='Title';
        if(t=='world_clock') b.locations=[{label:'London',timezone:'Europe/London', _searchVal:'London, UK'}];
        if(t=='date_display') {
            b.line1=['day_name_full', 'month_full', 'date_num'];
            b.line2=['week_num', 'separator', 'quarter'];
        }
        if(t=='progress_group') {
            b.items = [
                {type:'life', label:'Life', visible:true, dob:'1990-01-01', expectancy:85},
                {type:'year', label:'Year', visible:true},
                {type:'month', label:'Month', visible:true},
                {type:'week', label:'Week', visible:true},
                {type:'day', label:'Day', visible:true}
            ];
        }
        if(t=='progress_custom') { b.label='Goal'; b.start='2026-01-01'; b.end='2026-12-31'; }
        if(t=='progress_cycle') { b.label='Cycle'; b.anchor='2026-01-01'; b.days='28'; }
        if(t=='countdown') { b.label='Event'; b.date='2026-12-31'; b.style='standard'; }
        if(t=='timer') { b.label='Focus'; b.hours=0; b.minutes=25; }
        blocks.push(b); renderBlocks(); updateState();
    };
    window.removeBlock = (i) => { blocks.splice(i, 1); renderBlocks(); updateState(); };

    function handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();
        if (dragSrc !== this) {
            const s = parseInt(dragSrc.dataset.index);
            const t = parseInt(this.dataset.index);
            const item = blocks[s]; blocks.splice(s, 1); blocks.splice(t, 0, item);
            renderBlocks(); updateState();
        }
        return false;
    }

    function generateLink() {
        const json = JSON.stringify({ settings, blocks });
        const encoded = btoa(json);
        let url = window.location.href.split('#')[0].split('?')[0];
        if(url.endsWith('admin.html')) url = url.substring(0, url.lastIndexOf('/'));
        if(url.endsWith('/')) url = url.slice(0, -1);
        const final = `${url}/index.html#${encoded}`;
        document.getElementById('result-url').innerText = final;
        return final;
    }
    window.copyLink = () => { 
        navigator.clipboard.writeText(document.getElementById('result-url').innerText)
            .then(() => {
                const btn = document.getElementById('btn-copy');
                const orig = btn.innerText;
                btn.innerText = "COPIED!";
                setTimeout(() => btn.innerText = orig, 1000);
            });
    };

    init();
</script>
</body>
</html>
