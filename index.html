<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Widget V7</title>
    <style>
        :root {
            --bg-color: #FFFFFF; --text-color: #37352F; --accent-color: #E3E2E0;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            --base-size: 16px;

            /* Full Palette */
            --c-gray: #9B9A97; --c-brown: #64473A; --c-orange: #D9730D; --c-yellow: #DFAB01; 
            --c-green: #0F7B6C; --c-blue: #0B6E99; --c-purple: #6940A5; --c-pink: #AD1A72; --c-red: #E03E3E;
            --c-slate: #34495e; --c-teal: #1abc9c; --c-cyan: #00b8d4; --c-indigo: #3f51b5; 
            --c-lime: #82c91e; --c-amber: #f39c12; --c-rose: #e91e63;
        }
        @media (prefers-color-scheme: dark) {
            :root { --bg-color: #191919; --text-color: #D4D4D4; --accent-color: #2F2F2F; }
        }
        
        body { margin: 0; padding: 1.25rem; font-family: var(--font-stack); background: var(--bg-color); color: var(--text-color); font-size: var(--base-size); min-height: 100vh; position: relative; box-sizing: border-box;}

        /* LAYOUT */
        #dashboard { display: flex; flex-wrap: wrap; gap: 1.5rem; max-width: 800px; margin: 0 auto; align-items: flex-start; }
        .widget-block { width: 100%; box-sizing: border-box; }
        .widget-block.half-width { width: calc(50% - 0.75rem); }

        /* STYLES */
        .theme-card .widget-block { border: 1px solid var(--accent-color); padding: 1rem; border-radius: 8px; }
        .theme-minimal .clock-time, .theme-minimal .countdown-time { font-weight: 400 !important; }
        .theme-minimal .progress-bg { height: 4px !important; }

        .widget-header { font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px; opacity: 0.6; margin-bottom: 0.5rem; font-weight: 600; color: var(--block-color, inherit); }
        
        /* CLOCKS */
        .clock-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--accent-color); padding: 0.5rem 0; }
        .clock-row:last-child { border-bottom: none; }
        .clock-left { display: flex; flex-direction: column; }
        .clock-city { font-weight: 600; font-size: 0.95em; }
        .clock-date { font-size: 0.75em; opacity: 0.6; }
        .clock-time { font-family: "SF Mono", monospace; font-weight: 700; color: var(--block-color, inherit); font-size: 1.1em; }

        /* PROGRESS */
        .progress-wrapper { margin-bottom: 0.75rem; }
        .progress-meta { display: flex; justify-content: space-between; font-size: 0.85em; margin-bottom: 0.25rem; font-weight: 500; }
        .progress-bg { height: 10px; background-color: var(--accent-color); border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background-color: var(--block-color, var(--text-color)); width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .cycle-reset-btn { 
            background: none; border: 1px solid var(--text-color); 
            color: var(--text-color); font-size: 0.7rem; padding: 2px 6px; 
            border-radius: 4px; cursor: pointer; margin-left: 8px; 
            opacity: 0.7; transition: opacity 0.2s;
        }
        .cycle-reset-btn:hover { opacity: 1; background: var(--accent-color); }

        /* COUNTDOWN */
        .countdown-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .countdown-time { font-family: "SF Mono", monospace; font-weight: 700; background: var(--accent-color); padding: 2px 6px; border-radius: 4px; font-size: 0.9em; color: var(--block-color, inherit); }

        /* DATE BLOCK */
        .date-display { font-size: 1.5em; font-weight: 700; color: var(--block-color, inherit); line-height: 1.2; }
        .date-sub { font-size: 0.9em; opacity: 0.6; margin-top: 4px; font-weight: 500; }

        /* TIMER */
        .timer-container { text-align: center; padding: 10px; background: var(--accent-color); border-radius: 8px; }
        .timer-display { font-size: 2em; font-weight: 700; font-family: "SF Mono", monospace; margin: 10px 0; color: var(--block-color, inherit); }
        .timer-controls { display: flex; gap: 10px; justify-content: center; }
        .timer-btn { background: var(--bg-color); color: var(--text-color); border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: 600; flex:1;}
        
        #edit-btn {
            position: fixed; bottom: 10px; right: 10px; background: var(--text-color); color: var(--bg-color);
            width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s; cursor: pointer; text-decoration: none; font-size: 14px; z-index: 999;
        }
        body:hover #edit-btn { opacity: 0.4; } #edit-btn:hover { opacity: 1; }
        .error { width: 100%; color: #eb5757; text-align: center; padding: 20px; }
    </style>
</head>
<body>
    <div id="dashboard"></div>
    <a id="edit-btn" href="#" target="_blank" title="Edit Widget">✎</a>

    <script>
        function getConfig() {
            try {
                const hash = window.location.hash.substring(1); 
                if (!hash) return null;
                const data = JSON.parse(atob(hash));
                if (Array.isArray(data)) return { settings: {}, blocks: data };
                return data;
            } catch (e) { return null; }
        }

        const container = document.getElementById('dashboard');

        function render() {
            const data = getConfig();
            if (!data) { container.innerHTML = `<div class="error">No settings found.<br>Use admin.html to generate a link.</div>`; return; }
            document.getElementById('edit-btn').href = window.location.href.replace('index.html', 'admin.html');
            
            const settings = data.settings || {};
            document.body.className = `theme-${settings.theme || 'standard'}`;
            if(settings.fontSize === 'small') document.documentElement.style.setProperty('--base-size', '14px');
            if(settings.fontSize === 'large') document.documentElement.style.setProperty('--base-size', '18px');

            container.innerHTML = ''; 

            data.blocks.forEach((block, index) => {
                const blockDiv = document.createElement('div');
                blockDiv.className = 'widget-block';
                blockDiv.id = `block-${index}`;
                if (block.width === '50') blockDiv.classList.add('half-width');
                if (block.color && block.color !== 'default') {
                    const val = block.color.startsWith('#') ? block.color : `var(--c-${block.color})`;
                    blockDiv.style.setProperty('--block-color', val);
                }

                if (block.type === 'header') renderHeader(block, blockDiv);
                else if (block.type === 'world_clock') renderWorldClock(block, blockDiv, settings);
                else if (block.type === 'progress_group') renderProgressGroup(block, blockDiv);
                else if (block.type === 'progress_custom') renderCustomBar(block, blockDiv);
                else if (block.type === 'progress_cycle') renderCycleProgress(block, blockDiv, index);
                else if (block.type === 'countdown') renderCountdown(block, blockDiv);
                else if (block.type === 'timer') renderTimer(block, blockDiv, index);
                else if (block.type === 'date_display') renderDateDisplay(block, blockDiv);
                
                container.appendChild(blockDiv);
            });
            updateDynamicElements(data.blocks, settings);
        }

        function renderHeader(data, parent) { const el = document.createElement('div'); el.className = 'widget-header'; el.innerText = data.text; parent.appendChild(el); }
        
        function renderWorldClock(data, parent) {
            data.locations.forEach((loc, i) => {
                const row = document.createElement('div'); row.className = 'clock-row';
                row.innerHTML = `<div class="clock-left"><span class="clock-city">${loc.label} <span class="clock-abbr" id="abbr-${parent.id}-${i}" style="font-weight:400; opacity:0.6; font-size:0.9em;"></span></span><span class="clock-date" id="date-${parent.id}-${i}">--</span></div><span class="clock-time" id="clock-${parent.id}-${i}">--:--</span>`;
                parent.appendChild(row);
            });
        }
        
        function renderDateDisplay(data, parent) { 
            parent.innerHTML = `<div class="date-display" id="date-main-${parent.id}"></div><div class="date-sub" id="date-sub-${parent.id}"></div>`; 
        }
        function renderProgressGroup(data, parent) { data.items.forEach(item => { const dates = getDatesForType(item.type); if(dates) parent.appendChild(createBarElement(item.label, dates.start, dates.end, false)); }); }
        function renderCustomBar(data, parent) { parent.appendChild(createBarElement(data.label, new Date(data.start), new Date(data.end), false)); }
        function renderCycleProgress(data, parent, id) { 
            const wrapper = createBarElement(data.label, null, null, true, `block-${id}`);
            parent.appendChild(wrapper);
        }
        function renderCountdown(data, parent) { parent.innerHTML = `<div class="countdown-row"><span class="countdown-label">${data.label}</span><span class="countdown-time" id="cnt-${parent.id}">--</span></div>`; }
        function renderTimer(data, parent, id) {
            const hrs = parseInt(data.hours)||0; const mins = parseInt(data.minutes)||0; const total = (hrs*60)+mins; const label = hrs>0 ? `${hrs}h ${mins}m` : `${mins}m`;
            parent.innerHTML = `<div class="timer-container"><div style="font-size:0.8em; opacity:0.7;">${data.label||'Timer'}</div><div class="timer-display" id="timer-display-${id}">00:00</div><div class="timer-controls"><button class="timer-btn" onclick="startTimer(${id}, ${total})">Start ${label}</button><button class="timer-btn" style="color:#eb5757" onclick="stopTimer(${id})">Stop</button></div></div>`;
        }

        // --- UPDATE LOOP ---
        function updateDynamicElements(blocks, settings) {
            const now = new Date();
            const use24h = settings.use24h === true;
            blocks.forEach((block, bIdx) => {
                if (block.type === 'world_clock') {
                    block.locations.forEach((loc, lIdx) => {
                        try {
                            const timeEl = document.getElementById(`clock-block-${bIdx}-${lIdx}`);
                            const dateEl = document.getElementById(`date-block-${bIdx}-${lIdx}`);
                            const abbrEl = document.getElementById(`abbr-block-${bIdx}-${lIdx}`);
                            if(timeEl) {
                                const tz = (loc.timezone && loc.timezone !== 'local') ? loc.timezone : undefined;
                                const tOpts = { hour: use24h?'2-digit':'numeric', minute:'2-digit', hour12: !use24h }; if(tz) tOpts.timeZone = tz;
                                let tStr = now.toLocaleTimeString([], tOpts); if(!use24h) tStr = tStr.replace(' ', '');
                                timeEl.innerText = tStr;
                                const dOpts = { weekday: 'short', month: 'short', day: 'numeric' }; if(tz) dOpts.timeZone = tz;
                                dateEl.innerText = now.toLocaleDateString([], dOpts);
                                if(abbrEl && abbrEl.innerText === '') {
                                    const aOpts = { timeZoneName: 'short' }; if(tz) aOpts.timeZone = tz;
                                    const parts = new Intl.DateTimeFormat('en-US', aOpts).formatToParts(now);
                                    const tzName = parts.find(p => p.type === 'timeZoneName'); if(tzName && tzName.value) abbrEl.innerText = `(${tzName.value})`;
                                }
                            }
                        } catch(e) {}
                    });
                }
                
                if (block.type === 'date_display') {
                    const mEl = document.getElementById(`date-main-block-${bIdx}`);
                    const sEl = document.getElementById(`date-sub-block-${bIdx}`);
                    if(mEl) {
                        const l1 = block.line1 || ['day_name_full', 'month_full', 'date_num'];
                        const l2 = block.line2 || ['week_num', 'separator', 'quarter'];
                        mEl.innerText = buildDateString(l1, now);
                        sEl.innerText = buildDateString(l2, now);
                    }
                }

                if (block.type === 'countdown') {
                    const el = document.getElementById(`cnt-block-${bIdx}`);
                    if(el) {
                        let target = new Date(block.date); 
                        if(!block.includeTime) target.setHours(0,0,0,0);
                        else if(block.time) {
                            const [h, m] = block.time.split(':');
                            target.setHours(h || 0, m || 0, 0, 0);
                        }

                        const diff = target - now;
                        if (diff <= 0) el.innerText = "Done";
                        else {
                            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                            if (block.style === 'standard') el.innerText = `${d+1} Days`;
                            else if (block.style === 'precise') el.innerText = `${d}d ${h}h`;
                            else el.innerText = `${d}d ${h}h ${m}m`;
                        }
                    }
                }

                if (block.type === 'progress_cycle') {
                    const resetMode = block.resetMode || 'auto';
                    let anchor = new Date(block.anchor);
                    if (resetMode === 'manual') {
                        const restartTs = localStorage.getItem(`cycle_reset_block-${bIdx}`);
                        if(restartTs) anchor = new Date(parseInt(restartTs));
                    }
                    const days = parseFloat(block.days) || 1; 
                    const duration = days * 86400000;
                    const elapsed = now - anchor;
                    let pct = 0; let isDone = false;
                    if(elapsed < 0) pct = 0;
                    else {
                        if (resetMode === 'auto') pct = ((elapsed % duration) / duration) * 100;
                        else { if (elapsed >= duration) { pct = 100; isDone = true; } else { pct = (elapsed / duration) * 100; } }
                    }
                    updateCycleBar(`block-${bIdx}`, pct, isDone);
                }
                
                if (block.type === 'timer') updateTimerDisplay(bIdx);
            });
        }

        // --- HELPERS ---
        function buildDateString(tokens, now) {
            return tokens.map(t => {
                const type = (typeof t === 'string') ? t : t.type;
                switch(type) {
                    case 'day_name_full': return now.toLocaleDateString([], {weekday:'long'});
                    case 'day_name_short': return now.toLocaleDateString([], {weekday:'short'});
                    case 'month_full': return now.toLocaleDateString([], {month:'long'});
                    case 'month_short': return now.toLocaleDateString([], {month:'short'});
                    case 'month_num': return (now.getMonth() + 1).toString().padStart(2, '0'); // NEW: Month Number
                    case 'date_num': return now.getDate();
                    case 'year': return now.getFullYear();
                    case 'week_num': return `Week ${getWeekNumber(now)}`;
                    case 'day_year': 
                        const year = now.getFullYear();
                        const isLeap = (year % 4 === 0 && year % 100 > 0) || year % 400 === 0;
                        return `Day ${getDayOfYear(now)} of ${isLeap ? 366 : 365}`;
                    case 'quarter': return `Q${Math.floor((now.getMonth() + 3) / 3)}`;
                    case 'separator': return '|';
                    default: return '';
                }
            }).join(' ');
        }

        function updateCycleBar(id, pct, isDone) {
            const bar = document.getElementById(`cycle-bar-${id}`); 
            const txt = document.getElementById(`cycle-pct-${id}`);
            if(bar && txt) { 
                bar.style.width = `${pct}%`; 
                if (isDone) {
                    if(!document.getElementById(`reset-btn-${id}`)) {
                        txt.innerHTML = `Completed <button id="reset-btn-${id}" class="cycle-reset-btn" onclick="resetCycle('${id}')">↻ Reset</button>`;
                    }
                } else {
                    txt.innerText = `${pct.toFixed(1)}%`;
                }
            }
        }
        
        window.resetCycle = (id) => {
            localStorage.setItem(`cycle_reset_${id}`, new Date().getTime());
            updateCycleBar(id, 0, false);
        };

        function createBarElement(label, start, end, isCycle, parentId) {
            let pct = 0;
            if(!isCycle) { 
                const now = new Date(); 
                if(now > end) pct = 100; else if(now > start) pct = ((now - start) / (end - start)) * 100; 
            }
            const wrapper = document.createElement('div'); wrapper.className = 'progress-wrapper';
            const idSuffix = isCycle ? `-${parentId}` : `-${Math.random().toString(36).substr(2,5)}`; 
            wrapper.innerHTML = `<div class="progress-meta"><span>${label}</span><span id="cycle-pct${idSuffix}">${pct.toFixed(1)}%</span></div><div class="progress-bg"><div class="progress-fill" id="cycle-bar${idSuffix}" style="width: ${pct}%"></div></div>`;
            return wrapper;
        }

        function getDatesForType(type) {
            const now = new Date(); const y = now.getFullYear(), m = now.getMonth();
            if (type === 'day') return { start: new Date(y, m, now.getDate()), end: new Date(y, m, now.getDate(), 23, 59, 59) };
            if (type === 'week') { const d = now.getDay(); const diff = now.getDate() - d + (d === 0 ? -6 : 1); const s = new Date(now.setDate(diff)); s.setHours(0,0,0,0); const e = new Date(s); e.setDate(s.getDate() + 7); return { start: s, end: e }; }
            if (type === 'month') return { start: new Date(y, m, 1), end: new Date(y, m + 1, 0) };
            if (type === 'year') return { start: new Date(y, 0, 1), end: new Date(y + 1, 0, 1) };
            return null;
        }
        function getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d - yearStart) / 86400000) + 1)/7); }
        function getDayOfYear(d) { const start = new Date(d.getFullYear(), 0, 0); const diff = d - start; return Math.floor(diff / (1000 * 60 * 60 * 24)); }
        
        window.startTimer = (id, m) => { localStorage.setItem(`notion_timer_${id}`, new Date().getTime() + (m * 60000)); updateTimerDisplay(id); };
        window.stopTimer = (id) => { localStorage.removeItem(`notion_timer_${id}`); updateTimerDisplay(id); };
        function updateTimerDisplay(id) {
            const el = document.getElementById(`timer-display-${id}`); const end = localStorage.getItem(`notion_timer_${id}`);
            if (!end) { el.innerText = "00:00"; return; }
            const dist = end - new Date().getTime();
            if (dist < 0) { el.innerText = "Done!"; localStorage.removeItem(`notion_timer_${id}`); return; }
            const m = Math.floor(dist / 60000); const s = Math.floor((dist % 60000) / 1000);
            el.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }
        render(); setInterval(() => { const d = getConfig(); if(d) updateDynamicElements(d.blocks, d.settings); }, 1000);
    </script>
</body>
</html>
